set(
    OBJTARGETS
        naunet_constants
        naunet_physics
        naunet_rates
        naunet_fex
        naunet_jac
)

# Functions from Numerical Recipes, not suppport GPU yet.
if(NOT "CUDA" IN_LIST languages)
    list(
        APPEND OBJTARGETS
            naunet_utilities
    )
endif()

{% if info.device == "gpu" -%}
foreach(name ${OBJTARGETS})
    add_library(
        ${name}
            OBJECT
            ${name}.cu
    )
    set_target_properties(
        ${name}
            PROPERTIES
                CUDA_SEPARABLE_COMPILATION ON
    )
    target_include_directories(
        ${name}
            PRIVATE
                ${CMAKE_CUDA_TOOLKIT_INCLUDE_DIRECTORIES}
            PUBLIC
                ${CMAKE_SOURCE_DIR}/include
    )
    target_link_libraries(
        ${name}
            ${SUNDIALSLIB}
    )
endforeach()
{% else %}
foreach(name ${OBJTARGETS})
    add_library(
        ${name}
            OBJECT
            ${name}.cpp
    )
    target_include_directories(
        ${name}
            PUBLIC
                ${CMAKE_SOURCE_DIR}/include
    )
    target_link_libraries(
        ${name}
            ${SUNDIALSLIB}
    )
endforeach()
{% endif %}

if(MAKE_SHARED)
    add_library(
        naunet_shared
            SHARED
            naunet.cpp
    )
    set_target_properties(
        naunet_shared
            PROPERTIES
                OUTPUT_NAME naunet
    )
    {% if info.device == "gpu" -%}
    set_target_properties(
        naunet_shared
            PROPERTIES
                CUDA_SEPARABLE_COMPILATION ON
    )
    target_include_directories(
        naunet_shared
            PRIVATE
                ${CMAKE_CUDA_TOOLKIT_INCLUDE_DIRECTORIES}
            PUBLIC
                ${CMAKE_SOURCE_DIR}/include
    )
    {% else -%}
    target_include_directories(
        naunet_shared
            PUBLIC
                ${CMAKE_SOURCE_DIR}/include
    )
    {% endif -%}
    target_link_libraries(
        naunet_shared
            ${OBJTARGETS}
            ${SUNDIALSLIB}
    )
    install(
        TARGETS naunet_shared
        LIBRARY
        DESTINATION lib
    )
endif()

if(MAKE_STATIC)
    add_library(
        naunet_static
            STATIC
            naunet.cpp
    )
    set_target_properties(
        naunet_static
            PROPERTIES
                OUTPUT_NAME naunet
    )
    {% if info.device == "gpu" -%}
    set_target_properties(
        naunet_static
            PROPERTIES
                CUDA_SEPARABLE_COMPILATION ON
    )
    target_include_directories(
        naunet_static
            PRIVATE
                ${CMAKE_CUDA_TOOLKIT_INCLUDE_DIRECTORIES}
            PUBLIC
                ${CMAKE_SOURCE_DIR}/include
    )
    {% else -%}
    target_include_directories(
        naunet_static
            PUBLIC
                ${CMAKE_SOURCE_DIR}/include
    )
    {% endif -%}
    target_link_libraries(
        naunet_static
            ${OBJTARGETS}
            ${SUNDIALSLIB}
    )
    install(
        TARGETS naunet_static
        LIBRARY
        DESTINATION lib
    )
endif()


if(MAKE_PYTHON)

    include(FetchContent)
    FetchContent_Declare(
        pybind11_sources
        GIT_REPOSITORY https://github.com/pybind/pybind11.git
        GIT_TAG v2.6.2
    )
    FetchContent_GetProperties(pybind11_sources)
    if(NOT pybind11_sources_POPULATED)
        FetchContent_Populate(pybind11_sources)
        add_subdirectory(
            ${pybind11_sources_SOURCE_DIR}
            ${pybind11_sources_BINARY_DIR}
        )
    endif()

    add_library(${PYMODNAME} MODULE naunet.cpp)
    target_compile_definitions(${PYMODNAME}
        PUBLIC
            -DPYMODULE
            -DPYMODNAME=${PYMODNAME}
    )

    set_target_properties(${PYMODNAME}
        PROPERTIES
            {% if info.device == "gpu" -%}
            CUDA_SEPARABLE_COMPILATION ON
            {% endif -%}
            PREFIX "${PYTHON_MODULE_PREFIX}"
            SUFFIX "${PYTHON_MODULE_EXTENSION}"
    )

    target_include_directories(
        ${PYMODNAME}
            PUBLIC
                ${CMAKE_SOURCE_DIR}/include
            {% if info.device == "gpu" -%}
            PRIVATE
                ${CMAKE_CUDA_TOOLKIT_INCLUDE_DIRECTORIES}
            {%- endif %}

    )

    target_link_libraries(
        ${PYMODNAME}
            PUBLIC
                pybind11::module
            PRIVATE
                ${SUNDIALSLIB}
                ${OBJTARGETS}
    )

    install(
        TARGETS ${PYMODNAME}
        LIBRARY
        DESTINATION python
    )

endif()

install(
    DIRECTORY ${PROJECT_SOURCE_DIR}/include/
    DESTINATION include
)
